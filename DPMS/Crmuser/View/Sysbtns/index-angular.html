<extend name="angular-base.html" />
<block name="headcss">
</block>
<block name="headjs">
    <script src="{$Think.const.BOOTSTRAP_URL}angular-sanitize/{$Think.const.ANGULAR_VERSION}angular-sanitize.min.js"></script>
    <script>
        //初始化modal并定义service
        appModuleInit(['ui.bootstrap', 'ui.grid', 'ui.grid.emptyBaseLayer', 'ui.grid.pagination', 'ui.grid.resizeColumns', 'ui.grid.autoResize', 'ngVerify', 'datePicker', 'ui.select', 'ngSanitize']);
        /* service 数据源
         数据表名称+Data或业务名称+Data
          sysbtnsData
         */
        //要在表格中显示的字段及名称，提取出来便于更改和查看
        function columns(vm, uiGridConstants) {
            return [{
                name: 'idsysbtns', displayName: '图标', enableFiltering: false, cellClass: 'text-center',
                cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                    return '<i class="fa fa-mouse-pointer bigger-120"></i>'
                }
            }, {
                name: 'bname', displayName: '按钮名称', enableFiltering: true,
                menuItems: [{
                    title: '检索',
                    icon: 'ui-grid-icon-search',
                    action: function () {
                        vm.toggleFiltering(vm, uiGridConstants);
                    }
                }], cellClass: 'text-center',

            }, {
                name: 'content', displayName: '详细内容', enableFiltering: false,
                cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                    return '<div  ng-bind-html="grid.appScope.btnPreview(grid, row, col, rowRenderIndex, colRenderIndex)"></div>';
                },
                cellClass: 'text-center'
            },
             { name: 'code', displayName: '代号', enableFiltering: false, cellClass: 'text-center' },
             {
                 name: 'del', displayName: '操作', enableFiltering: false, cellClass: 'text-left',
                 cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                     return '<a href="javascript:;" class="green top-5" ng-show="grid.appScope.service.refedit"  ng-click="grid.appScope.updateInfo(grid, row, col, rowRenderIndex, colRenderIndex)"><i class="glyphicon glyphicon-pencil bigger-120"></i></a>&nbsp;&nbsp;<a href="javascript:;" class="red top-5" ng-show="grid.appScope.service.refdel"  ng-click="grid.appScope.remove(grid, row, col, rowRenderIndex, colRenderIndex)"><i class="glyphicon glyphicon-trash bigger-120"></i></a> '
                 }
             }
            ];


        }



        //主控制器
        appModule.controller('crmSysbtnsController', ['$scope', 'i18nService', 'dataService', 'uiGridConstants', 'alert', function ($scope, i18nService, dataService, uiGridConstants, alert) {
            // 国际化；
            i18nService.setCurrentLang("zh-cn");
            $scope.service = dataService;//要显示到页面上的数据源
            //ui-grid改变高度方法
            $scope.changeHeight = function () {
                var newHeight = document.body.clientHeight - 115;
                angular.element(document.getElementsByClassName('ui-grid')[0]).css('height', newHeight + 'px');
            };
            /*
                查询用户（本页面使用）数据
            */
            $scope.select = function () {
                $scope.service.postData(__URL + 'Crmuser/Sysbtns/select_page_data', {}).then(function (data) {
                    $scope.service.allData = data;
                    $scope.gridOptions.data = $scope.service.allData;
                    $scope.changeHeight();
                }, function (error) {
                    console.log(error);
                });
            }

            //表格配置对象
            $scope.gridOptions = publicControllerGridOptions($scope);
            //表格列头
            $scope.gridOptions.columnDefs = columns($scope, uiGridConstants);
            //显示、隐藏检索方法
            $scope.toggleFiltering = function () {
                $scope.gridOptions.enableFiltering = !$scope.gridOptions.enableFiltering;
                $scope.gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN);
            };
            //仅用作了附加默认值做判断使用，手机、紧急电话、现居地址为空则是undefined的情况
            $scope.defaultvalue = function (value) {
                if (value == "undefined") {
                    var html = '暂无';
                } else {
                    var html = value;
                }
                return html;
            };
            $scope.btnPreview = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                return row.entity.content;
            }
            //刷新按钮
            $scope.refresh = refresh;

            //添加按钮
            $scope.add = function () {
                $scope.service.title = '新建按钮';
                $scope.modalHtml = __URL + 'Crmuser/Sysbtns/openmodal';
                $scope.modalController = 'modalSysbtnsController';
                $scope.service.selectItem = '';
                publicControllerAdd($scope);
            };
            //修改按钮
            $scope.updateInfo = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = "修改按钮";
                $scope.modalHtml = __URL + 'Crmuser/Sysbtns/openmodal';
                $scope.modalController = 'modalSysbtnsController';
                $scope.service.selectItem = row.entity;
                $scope.service.selectItem.content = $scope.service.selectItem.content == "undefined" ? '暂无' : $scope.service.selectItem.content;
                publicControllerUpdate($scope);
            };
            //删除按钮
            $scope.remove = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = '删除按钮';
                $scope.modalHtml = __URL + 'Crmuser/Sysbtns/openmodal';
                $scope.modalController = 'modalSysbtnsController';
                $scope.service.selectItem = row.entity;
                publicControllerDel($scope);
            };
            //页面加载完成后，查询数据
            $scope.select();
        }]);
    </script>
</block>
<block name="pageContent">
    <!--页头-->
    <div class="page-header clearfix">
        <h1 class="col-xs-3 text-left">
            {$MenuName}
            <small>
                <i class="ace-icon fa fa-angle-double-right"></i>
                {$PageName}
            </small>
        </h1>
        <div class="col-xs-4 text-center">
            <!--<a ng-click="add()" class="btn btn-success  btn-sm">
                <i class="glyphicon glyphicon-plus"></i>
                添加
            </a>
            <a ng-click="refresh()" class="btn btn-success btn-sm">
                <i class="glyphicon glyphicon-refresh"></i>刷新
            </a>-->
            <!--{$_SESSION['operation_button']['btn100035']['btn_value']}
            {$_SESSION['operation_button']['btn100036']['btn_value']}-->
            <page-btn></page-btn>
        </div>
    </div>
    <!--快速检索-->
    <div class="table-header clearfix">
        <div class="col-xs-6">{$MenuName}<small><i class="ace-icon fa fa-angle-double-right"></i>{$PageName}</small></div>
    </div>
    <div>
        <div ui-grid="gridOptions" ui-grid-grouping ui-grid-empty-base-layer ui-grid-auto-resize ui-grid-resize-columns ui-grid-pagination></div>
    </div>
</block>
<block name="scriptTemplate">

</block>

<block name="footjs">
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Crmuser/Sysbtns/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.JS_URL}directive.pagebtn.js"></script>
</block>
