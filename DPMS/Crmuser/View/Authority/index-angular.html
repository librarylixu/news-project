<extend name="angular-base.html" />
<block name="headcss">
</block>
<block name="headjs">
    <script src="{$Think.const.BOOTSTRAP_URL}angular-sanitize/{$Think.const.ANGULAR_VERSION}angular-sanitize.min.js"></script>
    <script>
       
    </script>
    <script>
        //初始化modal并定义service
        appModuleInit(['ui.bootstrap', 'ngVerify', 'datePicker', 'ui.select']);
        
        //主控制器
        appModule.controller('crmAuthorityController', ['$scope', '$q', 'dataService', 'alert', function ($scope,$q, dataService, alert) {
            _$scope = $scope;
            _$q = $q;
            $scope.service = dataService;//要显示到页面上的数据源
           
            /*
                查询权限（本页面使用）数据
            */
            $scope.select = function () {
                    select_authority().then(function (res) {                      
                        $scope.selecttype();
                    });
            }
            //显示到页面上的数据源
            $scope.authorityData = [];
          
           
            //刷新按钮
            $scope.refresh = refresh;
            //获取角色与之相关联数据的数量      
            $scope.getRefSouceLength = function (row, type) {
                var refCount = 0;
                if (type == 0) {
                    //权限
                    angular.forEach($scope.service.refusertypeData, function (value, key) {
                        if (value.authid == row.idauthority) {
                            refCount++;
                        }
                    });
                } else if (type == 1) {
                    //页面
                    angular.forEach($scope.service.refusergroupData, function (value, key) {
                        if (value.typeid == row.idusertype) {
                            refCount++;
                        }
                    });
                }
                return refCount;
            };
            //获取关联页面的数量
            $scope.getpageCount = function (row) {
                var refCount = 0;
                if (parent.authRefPage[row.idauthority]!==undefined) {
                    refCount = Object.keys(parent.authRefPage[row.idauthority]).length;
                }
                

                return refCount;
            }
           
            //添加按钮
            $scope.add = function () {
                $scope.service.title = '新建权限';
                $scope.modalHtml = __URL + 'Crmuser/Authority/openmodal';
                $scope.modalController = 'modelAuthorityController';
                $scope.service.selectItem = '';
                publicControllerAdd($scope);
            }
            //修改按钮
            $scope.updateInfo = function (row) {
                $scope.service.title = "修改权限";
                $scope.modalHtml = __URL + 'Crmuser/Authority/openmodal';
                $scope.modalController = 'modelAuthorityController';
                $scope.service.selectItem = row;
                publicControllerUpdate($scope);
            }
            //删除按钮
            $scope.remove = function (row) {
                $scope.service.title = '删除权限';
                $scope.modalHtml = __URL + 'Crmuser/Authority/openmodal';
                $scope.modalController = 'modelAuthorityController';
                $scope.service.selectItem = row;
                publicControllerDel($scope);
            }
            //分配权限按钮
            $scope.refusertype = function (row) {
                $scope.service.title = '关联角色';
                $scope.modalHtml = __URL + 'Crmuser/Authority/openmodal';
                $scope.modalController = 'modelAuthorityController';
                $scope.service.selectItem = row;
                $scope.service.Action = 3;
                publicControllerRef($scope);
            }
            //关联页面按钮
            $scope.refapp = function (row) {
                $scope.service.title = '关联页面';
                $scope.url = __URL + 'Crmuser/Authority/appinfo?authid=' + row.idauthority;
                parent.YL.open({
                    title: $scope.service.title,
                    url: $scope.url
                });
                
                //window.Win10_child.openUrl($scope.url, row.authname);
            }
            /*
            查询角色与权限关系数据
            */
            $scope.refselecttype = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/RefutypeRefauth/select_page_data', params).then(function (data) {
                    $scope.service.refusertypeData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询角色数据
            */
            $scope.selecttype = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                select_usertype(params).then(function (res) {   
                    //查询角色和角色的关系数据
                    $scope.refselecttype();                
                });
            }        
            //页面加载完成后，查询数据
            $scope.select();
            
        }]);
    </script>
</block>
<block name="pageContent">
    <!--页头-->
    <div class="page-header clearfix">
        <h1 class="col-xs-3 text-left">
            {$MenuName}
            <small>
                <i class="ace-icon fa fa-angle-double-right"></i>
                {$PageName}
            </small>
        </h1>
        <div class="col-xs-4 text-center">
            <page-btn></page-btn>
        </div>
    </div>
    <!--快速检索-->
    <div class="table-header clearfix">
        <div class="col-xs-6">{$MenuName}<small><i class="ace-icon fa fa-angle-double-right"></i>{$PageName}</small></div>

    </div>
    <div>
        <table class="table">
            <tr>
                <th>图标</th>
                <th>权限名称</th>
                <th>关联角色</th>
                <th>关联页面</th>
                <th>操作</th>                
            </tr>
            <tr ng-repeat="(key, row)  in service.privateDateObj.authorityData">
                <td><i class="fa fa-unlock-alt  bigger-120"></i></td>
                <td ng-bind="row.authname"></td>
                <td>
                    <a class="addref top-5" title="建立权限与用户角色关系" ng-click="refusertype(row,3)" href="javascript:;"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;(<span ng-bind="getRefSouceLength(row,0)"></span>)</a>
                </td>
                <td>
                    <a class="addref top-5" title="建立权限与页面关系" ng-click="refapp(row)" href="javascript:;"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;关联页面&nbsp;(<span ng-bind="getpageCount(row)"></span>)</a>
                </td>
                <td>
                    <a href="javascript:;" class="green top-5" ng-show="service.refedit" ng-click="updateInfo( row)"><i class="glyphicon glyphicon-pencil bigger-120"></i></a>&nbsp;&nbsp;
                    <a href="javascript:;" class="red top-5" ng-show="service.refdel" ng-click="remove(row)"><i class="glyphicon glyphicon-trash bigger-120"></i></a>
                </td>
            </tr>
        </table>
    </div>
</block>

<block name="scriptTemplate">

</block>

<block name="footjs">
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Crmuser/Authority/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Crmuser/Usertype/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.JS_URL}directive.pagebtn.js"></script>
</block>
