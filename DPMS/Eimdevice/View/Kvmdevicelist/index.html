<!--页头-->
<div class="page-header clearfix">
    <div class="col-xs-12 text-center">
        <a ng-click="btn_add()" class="btn btn-success btn-sm">
            <i class="glyphicon glyphicon-plus"></i>&nbsp;添加
        </a>
        <a ng-click="select(1)" class="btn btn-success btn-sm">
            <i class="glyphicon glyphicon-refresh"></i>&nbsp;刷新
        </a>
        <a ng-click="uploadfile()" class="btn btn-warning btn-sm">
            <i class="glyphicon glyphicon-upload"></i>&nbsp;批量导入
        </a>
    </div>
</div>
<div class="row">
    <div class="col-xs-2">
        <select ng-model="service.treevalue" ng-change="service.gettreedata(treevalue)">
            <option value="devicegroup">设备组</option>
            <option value="usergroup">用户组</option>
        </select>
        <eim-tree></eim-tree>
    </div>
    <div class="col-xs-10">
        <div class="mt-5">
            <div class="table-header">
                KVM设备管理
            </div>
            <!--Device Show-->
            <table class="table table-striped table-bordered table-hover table-condensed table-responsive">
                <tr>
                    <th ng-repeat="name in service.privateDateObj.systemsettingData.deviceset.value.kvmlistth track by $index">
                        <span ng-bind="service.privateDateObj.kvmcolumnameData[name].name"></span>
                    </th> 
                    <th>操作</th>
                </tr>
                <tbody ng-repeat="(key,item) in service.privateDateObj.kvmdeviceData" ng-if="!item.display">
                    <tr >
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('networkstatus')>-1">
                            <span class="label" ng-class="item.networkstatus==1?'label-success':''" ng-bind="item.networkstatus==1?'在线':'离线'"></span>
                        </td>
                        <td ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('devicename')>-1" >
                            <span  ng-bind="item.displayname?item.displayname:item.devicename"></span>                           
                        </td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('ipaddress')>-1" ng-bind="item.ipaddress"></td>
                        <td ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('modeltypeid')>-1">
                            <span ng-bind="service.privateDateObj.modeltypeData[item.modeltypeid].modelname"></span>
                        </td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('contactpeople')>-1" ng-bind="item.contactpeople"></td>
                        <td   ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('remark')>-1"  ng-bind="item.remark"></td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('opensession')>-1" >
                            <a href="javascript:;" class="orange top-5" ng-click="btn_synchronization(item)"><i class="glyphicon glyphicon-refresh fa-lg"></i></a>
                        </td>
                        <td>
                            <a href="javascript:;" class="green top-5" ng-click="updateInfo(item)"><i class="glyphicon glyphicon-pencil fa-lg"></i></a>&nbsp;
                            <a href="javascript:;" class="red top-5" ng-click="btn_del(item)"><i class="glyphicon glyphicon-trash fa-lg"></i></a>
                           
                        </td>
                    </tr>
                    <tr ng-repeat="(k,value) in service.privateDateObj.kvmportlistData" ng-if="value.kvmid==key">
                        <td class="text-right"  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('networkstatus')>-1">
                            <span class="label label-success" ng-if="value.onofflinestatus=='online'">[开机]</span>
                            <span class="label" ng-if="value.onofflinestatus=='offline'">[关机]</span>                           
                            <span class="label badge-inverse" ng-if="value.onofflinestatus&&value.onofflinestatus!='offline'&&value.onofflinestatus!='online'">[未知]</span>
                        </td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('devicename')>-1">
                            <span ng-bind="value.displayname?value.displayname:value.portname"></span>
                        </td>
                        <td ng-bind="value.portnum"></td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('modeltypeid')>-1">
                            <span ng-bind="service.privateDateObj.modeltypeData[value.modeltypeid].modelname"></span>
                        </td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('contactpeople')>-1" ng-bind="value.contactpeople"></td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('remark')>-1" ng-bind="value.remark"></td>
                        <td  ng-if="service.privateDateObj.systemsettingData.deviceset.value.kvmlistth.indexOf('opensession')>-1">
                            <div style="display:inline-block;width:30px;padding:0 2px;" ng-repeat="type in (value.devicesessiontypeids?value.devicesessiontypeids.split(','):[])">
                                <div ng-if="type=='6'">
                                    <local-kvm></local-kvm>
                                </div>
                                <div ng-if="type=='7'">
                                    <dsv-kvm></dsv-kvm>
                                </div>                               
                            </div>   
                            <div style="display:inline-block;width:30px;padding:0 2px;"  
                                ng-if="!value.devicesessiontypeids"
                               ng-repeat="type in item.devicesessiontypeids?item.devicesessiontypeids.split(','):[]">
                                <div ng-if="type=='6'">
                                    <local-kvm></local-kvm>
                                </div>
                                <div ng-if="type=='7'">
                                    <dsv-kvm></dsv-kvm>
                                </div>

                            </div>  
                        </td>
                        <td>
                            <a href="javascript:;" class="green top-5" ng-click="updateInfo(value)"><i class="glyphicon glyphicon-pencil fa-lg"></i></a>&nbsp;
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="text-right">共<b class="blue" ng-bind="length(service.privateDateObj.kvmdeviceData)"></b>条</div>
        </div>
    </div>
</div>
<script type="text/ng-template" id='Eimdevice/Kvmdevicelist/openmodal'>
    <div class="modal-header clearfix">
        <h4 class="modal-title f-l">{{Source.title}}</h4>
        <a href="javascript:;" class="closebtn" ng-click="btn_cancel()"><i class="glyphicon glyphicon-remove"></i></a>
    </div>
    <div class="modal-body">
        <form name="Form" verify-scope>
            <table class="table">
                <tr class="info">
                    <td colspan="4">基本信息</td>
                </tr>
                <tr>
                    <td class="text-right">设备名称</td>
                    <td>
                        <input ng-if="Source.Action==0||(Source.selectItem.idkvmlist&&Source.selectItem.displayname)" type="text" ng-verify="{min:{{Source.privateDateObj.systemsettingData.namelength.value.minlength}}, max:{{Source.privateDateObj.systemsettingData.namelength.value.maxlength}}}" class="form-control" ng-model="Source.selectItem.displayname" placeholder="请输入1~25个字符" />
                        <input  ng-if="Source.selectItem.idkvmlist&&!Source.selectItem.displayname" type="text" ng-verify="min:{{Source.privateDateObj.systemsettingData.namelength.value.minlength}}, max:{{Source.privateDateObj.systemsettingData.namelength.value.maxlength}}" class="form-control" ng-model="Source.selectItem.devicename" placeholder="请输入1~25个字符" />
                        <input  ng-if="Source.selectItem.idkvmportlist&&!Source.selectItem.displayname"  type="text" ng-verify="min:{{Source.privateDateObj.systemsettingData.namelength.value.minlength}}, max:{{Source.privateDateObj.systemsettingData.namelength.value.maxlength}}" class="form-control" ng-model="Source.selectItem.portname" placeholder="请输入1~25个字符" />
                    </td>
                    <td>IP地址</td>
                    <td>
                        <input type="text" class="form-control" ng-model="Source.selectItem.ipaddress" ng-verify="{required:{Source.selectItem.idkvmportlist? false : true}}" placeholder="请输入设备IP地址" />
                    </td>
                </tr>
                <tr ng-if="Source.selectItem.idkvmlist||Source.Action==0">
                    <td class="text-right">设备类型</td>
                    <td>
                        <ui-select ng-model="Source.selectItem.seldevicetypeid" style="width:100%;" on-select="checked_devicetypeid()">
                            <ui-select-match placeholder="请选择设备类型">
                                <span ng-bind="$select.selected.value.typename" style="margin-right: 5px;">
                                </span>
                            </ui-select-match>
                            <ui-select-choices repeat="item.key  as (key,item) in service.privateDateObj.devicetypeData | filter: { value: { typename: $select.search }}"  style="max-height: 150px;">
                                <div ng-bind-html="item.value.typename | highlight: $select.search" ></div>
                            </ui-select-choices>
                        </ui-select>
                    </td>
                    <td>设备型号</td> 
                    <td>
                        <select ng-model="Source.selectItem.modeltypeid" ng-options="item.idmodeltype as item.modelname for item in OptionalmodeltypeData" ng-change="checked_modeltypeid();"></select>
                    </td>
                </tr>
                <tr ng-if="Source.selectItem.idkvmlist||Source.Action==0">
                    <td class="text-right">账号</td>
                    <td>
                        <input type="text" class="form-control" ng-model="Source.selectItem.loginuser" />
                    </td>
                    <td>密码</td>
                    <td>
                        <input type="password" class="form-control" ng-model="Source.selectItem.loginpwd" />
                    </td>
                </tr>
                <tr>
                    <td class="text-right">负责人</td>
                    <td colspan="3">
                        <input type="text" class="form-control" ng-model="Source.selectItem.contactpeople" />
                    </td>
                </tr>
                <tr>
                    <td class="text-right">备注</td>
                    <td colspan="3">
                        <textarea class="form-control" rows="3" ng-model="Source.selectItem.remark"></textarea>
                    </td>
                </tr>
                <tr class="info">
                    <td colspan="4">访问信息</td>
                </tr>
                <tr>
                    <td class="text-right">会话方式</td>
                    <td colspan="3">
                        <div class="checkbox" ng-repeat="item in service.privateDateObj.devicesessiontypeData" ng-if="item.iddevicesessiontype==6||item.iddevicesessiontype==7">
                            <label>
                                <input type="checkbox"
                                       name="{{item.typename}}"
                                       ng-true-value="item.iddevicesessiontype"
                                       ng-checked="Source.selectItem.devicesessiontypeids.indexOf(item.iddevicesessiontype)>-1"
                                       ng-click="ngchange_devicesessiontype(item)" /> {{item.typename}}
                            </label>
                        </div>
                    </td>
                </tr>
                <tr ng-if="!item.idkvmportlist">
                    <td class="text-right">会话控制中心</td>
                    <td colspan="3">
                        <select class="form-control"
                                ng-model="Source.selectItem.refsessioncenterid"
                                ng-options="item.idsessioncenterlist as item.name for item in service.sessioncenterData"></select>
                    </td>
                </tr>
                <tr ng-if="!item.idkvmportlist">
                    <td class="text-right">手动输入密码</td>
                    <td>
                        <input type="checkbox" ng-model="Source.selectItem.isenterpwd" />是
                    </td>
                    <td class="text-right">关联用户</td>
                    <td>
                        <div ng-if="Source.selectItem.isenterpwd">
                            <ui-select multiple ng-model="Source.selectItem.refenterpwd" style="width:100%;">
                                <ui-select-match placeholder="请选择关联用户">
                                    <span ng-bind="$item.value.description" style="margin-right: 5px;">
                                    </span>
                                </ui-select-match>
                                <ui-select-choices repeat="item.value.idusers  as (key,item) in service.privateDateObj.usersData | filter: { value: { description: $select.search }}" style="max-height: 150px;">
                                    <div ng-bind-html="item.value.description | highlight: $select.search"></div>
                                </ui-select-choices>
                            </ui-select>
                        </div>
                        <div ng-if="!Source.selectItem.isenterpwd">无</div>
                    </td>
                </tr>
                <tr>
                    <td class="text-right">设备组</td>
                    <td colspan="3">
                        <ui-select multiple ng-model="Source.selectItem.refdgroup" style="width:100%;">
                            <ui-select-match placeholder="请选择设备组">
                                <span ng-if="$item.value&&$item.value.pid!=0" ng-bind="$item.value.__parentname+'->'+$item.value.groupname" style="margin-right: 5px;">
                                </span>
                                <span ng-if="$item.value&&$item.value.pid==0" ng-bind="$item.value.groupname" style="margin-right: 5px;"> 
                                </span>
                            </ui-select-match>
                            <ui-select-choices repeat="item.key  as (key,item) in service.privateDateObj.devicegroupData | filter: { value: { groupname: $select.search }}" style="max-height: 150px;">
                                <div ng-if="item.value.pid!=0"
                                     ng-bind-html="item.value.__parentname+'->'+item.value.groupname | highlight: $select.search"></div>
                                <div ng-if="item.value.pid==0"
                                     ng-bind-html="item.value.groupname | highlight: $select.search"></div>
                            </ui-select-choices>
                        </ui-select>
                    </td>
                </tr>
                <tr>
                    <td class="text-right">用户组</td>
                    <td colspan="3">
                        <ui-select multiple ng-model="Source.selectItem.refugroup" style="width:100%;">
                            <ui-select-match placeholder="请选择关联用户组">
                                <span ng-if="$item.value.pid!=0" ng-bind="$item.value.__parentname+'->'+$item.value.groupname" style="margin-right: 5px;">
                                </span>
                                <span ng-if="$item.value.pid==0" ng-bind="$item.value.groupname" style="margin-right: 5px;">
                                </span>
                            </ui-select-match>
                            <ui-select-choices repeat="item.value.idusergroup  as (key,item) in service.privateDateObj.usergroupData | filter: { value: { groupname: $select.search }}" style="max-height: 150px;">
                                <div ng-if="item.value.idusergroup!=Source.selectItem.idusergroup&&item.value.pid!=0"
                                     ng-bind-html="item.value.__parentname+'->'+item.value.groupname | highlight: $select.search"></div>
                                <div ng-if="item.value.idusergroup!=Source.selectItem.idusergroup&&item.value.pid==0"
                                     ng-bind-html="item.value.groupname | highlight: $select.search"></div>
                            </ui-select-choices>
                        </ui-select>
                    </td>
                </tr>
                <tr>
                    <td class="text-right">用户</td>
                    <td colspan="3">
                        <ui-select multiple ng-model="Source.selectItem.refusers" style="width:100%;">
                            <ui-select-match placeholder="请选择关联用户">
                                <span ng-bind="$item.value.description" style="margin-right: 5px;">
                                </span>
                            </ui-select-match>
                            <ui-select-choices repeat="item.value.idusers  as (key,item) in service.privateDateObj.usersData | filter: { value: { description: $select.search }}" style="max-height: 150px;">
                                <div ng-bind-html="item.value.description | highlight: $select.search"></div>
                            </ui-select-choices>
                        </ui-select>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div class="modal-footer" style="clear:both;">
        <button class="btn btn-primary btn-sm" ng-verify="control:'Form'" type="button" ng-click="btn_save();">保存</button>
        <button class="btn btn-danger btn-sm" type="button" ng-click="btn_cancel();">取消</button>
    </div>
</script>
