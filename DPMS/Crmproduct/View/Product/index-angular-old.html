<extend name="angular-base.html" />
<block name="headcss">
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-colorpicker/3.0.32/css/colorpicker.min.css">
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angularTree/css/tree-control.css" />
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angularTree/css/tree-control-attribute.css" />
    <link rel="stylesheet" href="{$Think.const.CSS_URL}my-tree-style.css" />  
</block>
<block name="headjs">
    <script src="{$Think.const.BOOTSTRAP_URL}angularTree/js/angular-tree-control.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-sanitize/{$Think.const.ANGULAR_VERSION}angular-sanitize.min.js"></script>
    <script type="text/javascript" src="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-colorpicker/3.0.32/js/bootstrap-colorpicker-module.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular/{$Think.const.ANGULAR_VERSION}angular-touch.js"></script>
    <script>
        //初始化modal并定义service
        //'ngTouch', 'ui.grid.expandable', 'ui.grid.selection', 'ui.grid.pinning'
        appModuleInit(['ui.bootstrap', 'ui.grid', 'ui.grid.pagination', 'ui.grid.resizeColumns', 'ui.grid.autoResize', 'ngVerify', 'datePicker', 'ui.select', 'colorpicker.module', 'ui.grid.selection', 'ui.grid.pinning', 'ui.grid.grouping', 'treeControl']);
        //要在表格中显示的字段及名称，提取出来便于更改和查看
        function columns(vm, uiGridConstants) {
            return [
                  {
                      name: 'name', displayName: '型号', cellClass: 'text-center',

                  },
                  {
                      name: 'description', displayName: '描述', cellClass: 'text-center',

                  },
                   {
                       name: 'plist', displayName: '列表价', cellClass: 'text-center',

                   },
                  {
                      name: 'typeid', displayName: '类型', cellClass: 'text-center', grouping: {
                          groupPriority: 0
                      },
                      field: "_typeName"
                  }, {
                      name: 'idproductmodel', displayName: '操作', enableFiltering: false, cellClass: 'text-left',
                      cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                          return '<a href="javascript:;" class="green top-5" ng-show="row.entity.name!=undefined" ng-click="grid.appScope.updatemodel(grid, row, col, rowRenderIndex, colRenderIndex)"><i class="glyphicon glyphicon-pencil bigger-120"></i></a>&nbsp;&nbsp;<a href="javascript:;" class="red top-5"  ng-show="row.entity.name!=undefined"  ng-click="grid.appScope.removemodel(grid, row, col, rowRenderIndex, colRenderIndex)"><i class="glyphicon glyphicon-trash bigger-120"></i></a> '
                      }
                  }
            ];
        }
        //主控制器
        appModule.controller('crmProductController', ['$scope', 'i18nService', 'dataService', 'uiGridGroupingConstants', 'uiGridConstants', 'alert', function ($scope, i18nService, dataService, uiGridGroupingConstants, uiGridConstants, alert) {
            // 国际化；
            i18nService.setCurrentLang("zh-cn");
            $scope.service = dataService;//要显示到页面上的数据源
            //ui-grid改变高度方法
            $scope.changeHeight = function () {
                var newHeight = document.body.clientHeight - 115;
                angular.element(document.getElementsByClassName('ui-grid')[0]).css('height', newHeight + 'px');
            };
            //表格配置对象
            $scope.gridOptions = publicControllerGridOptions($scope);
            $scope.gridOptions.columnDefs = columns($scope, uiGridConstants);
            var params = new URLSearchParams();
            params.append('$json', true);
            //查询型号数据--页面数据
            $scope.select = function () {
                //产品型号
                $scope.service.postData(__URL + 'Crmproduct/Productmodel/select_page_data', params).then(function (data) {
                    $scope.service.productmodelData = data;
                    $scope.changeHeight();
                    //查询产品及与产品型号关系
                    $scope.selectproduct();
                    $scope.refselectproduct();
                    //查询类型数据
                    $scope.selectproducttype();
                    $scope.selectuser();//用户
                    $scope.selectusertype();//用户角色
                    $scope.selectusergroup();//用户组
                }, function (error) {
                    console.log(error);
                });
            }
            //刷新按钮
            $scope.refresh = refresh;

            //添加按钮
            $scope.add = function () {
                $scope.service.title = '新建产品类型';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = '';
                publicControllerAdd($scope);
            }
            //修改产品按钮
            $scope.updateInfo = function (data) {
                $scope.service.title = "修改产品类型";
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = data;
                publicControllerUpdate($scope);
            }
            //删除产品按钮
            $scope.remove = function (data) {
                $scope.service.title = '删除产品类型';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = data;
                publicControllerDel($scope);
            }
            //修改型号按钮
            $scope.updatemodel = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = "修改产品型号";
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = row.entity;
                $scope.service.Action = 4;
                publicControllerRef($scope);
            }
            //删除型号按钮
            $scope.removemodel = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = '删除产品型号';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = row.entity;
                $scope.service.Action = 5;
                publicControllerRef($scope);
            }
            //关联产品关联型号按钮
            $scope.refproductmodel = function (data) {
                $scope.service.title = '关联产品型号';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = data;
                $scope.service.Action = 3;
                publicControllerRef($scope);
            }
            //关联产品用户按钮
            $scope.refuser = function (data) {
                $scope.service.title = '关联用户';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = data;
                $scope.service.Action = 6;
                publicControllerRef($scope);
            }
            //产品关联用户角色按钮
            $scope.refusertype = function (data) {
                $scope.service.title = '关联用户角色';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = data;
                $scope.service.Action = 7;
                publicControllerRef($scope);
            }
            //产品关联用户组按钮
            $scope.refusergroup = function (data) {
                $scope.service.title = '关联用户组';
                $scope.modalHtml = __URL + 'Crmproduct/Product/openmodal';
                $scope.modalController = 'modelProductController';
                $scope.service.selectItem = data;
                $scope.service.Action = 8;
                publicControllerRef($scope);
            }
            //查询产品
            $scope.selectproduct = function () {
                //产品数据
                $scope.service.postData(__URL + 'Crmproduct/Product/select_page_data', params).then(function (data) {
                    $scope.service.productData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            //查询产品与产品型号关系
            $scope.refselectproduct = function () {
                //产品数据
                $scope.service.postData(__URL + 'Crmproduct/RefpromdRefpro/select_page_data', {}).then(function (data) {
                    $scope.service.refproductData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询产品类型数据
            */
            $scope.selectproducttype = function () {
                dataService.postData(__URL + 'Crmproduct/Producttype/select_page_data', params).then(function (data) {
                    $scope.service.producttypeData = data;
                    $scope.pagedata($scope.service.productmodelData, $scope.service.producttypeData);
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询用户数据
            */
            $scope.selectuser = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/Users/select_page_data', params).then(function (data) {
                    $scope.service.usersData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询用户角色数据
            */
            $scope.selectusertype = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/Usertype/select_page_data', params).then(function (data) {
                    $scope.service.usertypeData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询用户组数据
            */
            $scope.selectusergroup = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/Usergroup/select_page_data', params).then(function (data) {
                    $scope.service.usergroupData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            $scope.pagedata = function (productmodelData, producttypeData) {
                //最终页面数据源
                $scope.data = [];
                //第一层循环--型号数据
                for (var item in productmodelData) {
                    $scope.data.push(angular.copy(productmodelData[item]));//将copy后的型号数据追加到最终数据源中
                    var i = $scope.data.length - 1;//此处得到了下标

                    //组建型号-类型数据
                    var typeid = $scope.data[i].typeid;
                    if (typeid != null) {
                        $scope.data[i]['_typeName'] = producttypeData[typeid].name;
                    } else {
                        $scope.data[i]['_typeName'] = '暂无类型分组';
                    }

                }
                //二维数组的排序
                $scope.data.sort(function (x, y) {
                    return x.typeid - y.typeid;

                });
                //此时表示select为空时默认显示全部的数据
                $scope.gridOptions.data = $scope.data;
            }
            //select框改变时触发
            $scope.changeproduct = function () {
                $scope.data = [];
                if ($scope.selectproduct == null) {
                    $scope.pagedata($scope.service.productmodelData, $scope.service.producttypeData);
                    return;
                }
                //循环关系表，判断此时的产品id和关系表中id是否相等
                angular.forEach($scope.service.productmodelData, function (value, key) {
                    if (value.productid == $scope.selectproduct.idproduct) {
                        //得到了型号的id，将型号id追加到最终数据源中
                        var _modelid = value.idproductmodel;
                        $scope.data.push(angular.copy($scope.service.productmodelData[_modelid]));
                        var i = $scope.data.length - 1;//下标

                        //组建型号-类型数据
                        var typeid = $scope.data[i].typeid;
                        if (typeid != null) {
                            $scope.data[i]['_typeName'] = $scope.service.producttypeData[typeid].name;
                        } else {
                            $scope.data[i]['_typeName'] = '暂无类型分组';
                        }
                    }
                });
                //由select框选中后过滤之后的数据
                $scope.gridOptions.data = $scope.data;
            }
            //页面加载完成后，查询数据
            $scope.select();
        }]);
    </script>
</block>
<block name="pageContent">
    <!--页头-->
    <div class="page-header clearfix">
        
            <h1 class="col-xs-3 text-left">
                {$MenuName}
                <small>
                    <i class="ace-icon fa fa-angle-double-right"></i>
                    {$PageName}
                </small>               
            </h1>
        
        <div class="col-xs-4 text-center">
            <page-btn></page-btn>
        </div>

    </div>
    <div class="page-header">
        <form name="Form" verify-scope>
            <div style="display:inline-block;margin-left:0;">
                <select ng-options="p.name for p  in service.productData" ng-model="selectproduct" ng-verify="{errmsg:'请先选择产品，再对产品操作'}" ng-change="changeproduct()">
                    <option value="" selected>全部产品</option>
                </select>
            </div>
            <div style="display:inline-block;margin-right:0;">
                <button type="button" class="btn btn-white btn-success btn-sm" ng-verify="control:'Form'" ng-click="refproductmodel(selectproduct)"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;型号</button>&nbsp;
                <button type="button" class="btn btn-white btn-success btn-sm" ng-verify="control:'Form'" ng-click="refuser(selectproduct)"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;用户</button>&nbsp;
                <button type="button" class="btn btn-white btn-success btn-sm" ng-verify="control:'Form'" ng-click="refusertype(selectproduct)"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;角色</button>&nbsp;
                <button type="button" class="btn btn-white btn-success btn-sm" ng-verify="control:'Form'" ng-click="refusergroup(selectproduct)"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;用户组</button>&nbsp;
                <button type="button" class="btn btn-white btn-danger btn-sm" ng-verify="control:'Form'" ng-click="updateInfo(selectproduct)"><i class="glyphicon glyphicon-pencil bigger-120"></i>&nbsp;修改</button>&nbsp;
                <button type="button" class="btn btn-white btn-danger btn-sm" ng-verify="control:'Form'" ng-click="remove(selectproduct)"><i class="glyphicon glyphicon-trash bigger-120"></i>&nbsp;删除</button>

            </div>

        </form>
    </div>
    
    <!--快速检索-->
    <div class="table-header clearfix">
        <div class="col-xs-6">{$MenuName}<small><i class="ace-icon fa fa-angle-double-right"></i>{$PageName}</small></div>
    </div>
    <div>
        <div ui-grid="gridOptions" ui-grid-auto-resize ui-grid-resize-columns ui-grid-pagination ui-grid-empty-base-layer ui-grid-grouping></div>
    </div>
</block>

<block name="scriptTemplate">

</block>

<block name="footjs">
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Product/Product/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Product/Productmodel/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.JS_URL}directive.pagebtn.js"></script>
</block>
