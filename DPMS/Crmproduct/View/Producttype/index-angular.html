<extend name="angular-base.html" />
<block name="headcss">
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-colorpicker/3.0.32/css/colorpicker.min.css">
</block>
<block name="headjs">
    <script src="{$Think.const.BOOTSTRAP_URL}angular-sanitize/{$Think.const.ANGULAR_VERSION}angular-sanitize.min.js"></script>
    <script type="text/javascript" src="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-colorpicker/3.0.32/js/bootstrap-colorpicker-module.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular/{$Think.const.ANGULAR_VERSION}angular-touch.js"></script>

    <script>
        //初始化modal并定义service
        //'ngTouch', 'ui.grid.expandable', 'ui.grid.selection', 'ui.grid.pinning'
        appModuleInit(['ui.bootstrap', 'ui.grid', 'ui.grid.pagination', 'ui.grid.resizeColumns', 'ui.grid.autoResize', 'ngVerify', 'datePicker', 'ui.select', 'colorpicker.module', 'ngTouch', 'ui.grid.expandable', 'ui.grid.selection', 'ui.grid.pinning']);
        //要在表格中显示的字段及名称，提取出来便于更改和查看
        function columns(vm, uiGridConstants) {
            return [{
                name: 'idproducttype', displayName: '图标', enableFiltering: false, cellClass: 'text-center',
                cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                    return '<i class="fa fa-user bigger-120"></i>'
                }
            },
              {
                  name: 'name', displayName: '产品类型', enableFiltering: true, menuItems: [{
                      title: '检索',
                      icon: 'ui-grid-icon-search',
                      action: function () {
                          vm.toggleFiltering(vm, uiGridConstants);
                      }
                  }], cellClass: 'text-center',
                  
              },
              {
                  name: 'productRefmodel', displayName: '关联型号', enableFiltering: false, cellClass: 'text-center',
                  cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                      return '<a class="addref top-5 ng-scope" title="建立产品类型与产品型号关系" ng-click="grid.appScope.refproductmodel(grid, row, col, rowRenderIndex, colRenderIndex)" href="javascript:;"><i class="glyphicon glyphicon-resize-small"></i>&nbsp;(<span ng-bind="grid.appScope.getTypeRefSouceLength(row,0)"></span>)</a>'
                  }
              },
             {
                 name: 'group_type', displayName: '操作', enableFiltering: false, cellClass: 'text-left',
                 cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                     return '<a href="javascript:;" class="green top-5"  ng-click="grid.appScope.updateInfo(grid, row, col, rowRenderIndex, colRenderIndex)"><i class="glyphicon glyphicon-pencil bigger-120"></i></a>&nbsp;&nbsp;<a href="javascript:;" class="red top-5"  ng-click="grid.appScope.remove(grid, row, col, rowRenderIndex, colRenderIndex)"><i class="glyphicon glyphicon-trash bigger-120"></i></a> '
                 }
             }];
        }
        //产品型号列头
        function portColumns() {
            return {
                columnDefs: [
                            {name: 'idproductmodel', displayName: '图标', enableFiltering: false, cellClass: 'text-center',
                                cellTemplate: function (grid, row, col, rowRenderIndex, colRenderIndex) {
                                    return '<i class="fa fa-user bigger-120"></i>'
                                }
                            },
                            { name: 'name', displayName: '型号名称' },
                            { name: 'description', displayName: '描述', },
                            { name: 'manufacturers', displayName: '制造商' },
                            { name: 'plist', displayName: '列表价' },
                            { name: 'peu', displayName: 'eu底价' },
                            { name: 'psi', displayName: 'si底价' },
                            { name: 'pinter', displayName: '内部核算价' },
                ]
            };
        }
        //主控制器
        appModule.controller('crmProducttypeController', ['$scope', 'i18nService', 'dataService', 'uiGridConstants', 'alert', function ($scope, i18nService, dataService, uiGridConstants, alert) {
            // 国际化；
            i18nService.setCurrentLang("zh-cn");
            $scope.service = dataService;//要显示到页面上的数据源
            //ui-grid改变高度方法
            $scope.changeHeight = function () {
                var newHeight = document.body.clientHeight - 115;
                angular.element(document.getElementsByClassName('ui-grid')[0]).css('height', newHeight + 'px');
            };
            var params = new URLSearchParams();
            params.append('$json', true);
            $scope.select = function () {
                //producttypeData 产品类型，分组顶级数据
                //产品类型
                $scope.service.postData(__URL + 'Crmproduct/Producttype/select_page_data', params).then(function (data) {
                    $scope.service.producttypeData = data;
                    $scope.service.producttypeArray = P_objecttoarray(data);//转数组绑定表格
                    $scope.gridOptions.data = $scope.service.producttypeArray;
                    $scope.changeHeight();
                    //查询型号数据
                    $scope.selectmodel();
                }, function (error) {
                    console.log(error);
                });
            }
            //查询指定的产品型号
            $scope.selectproductmodel = function (type) {
                var params = new URLSearchParams();
                params.append('$json', true);
                params.append('$where', JSON.stringify({ typeid: type.idproducttype }));
                //产品型号数据
                $scope.service.postData(__URL + 'Crmproduct/Productmodel/select_page_data', params).then(function (data) {
                    $scope.service.productmodelArray = P_objecttoarray(data);//转数组绑定表格
                    type.subGridOptions.data = $scope.service.productmodelArray;
                }, function (error) {
                    console.log(error);
                });
            }
            //表格配置对象
            $scope.gridOptions = publicControllerGridOptions($scope);
            $scope.gridOptions.expandableRowTemplate = '<div ui-grid="row.entity.subGridOptions" style="height:150px;"></div>';
            //嵌套表格
            //$scope.gridOptions.expandableRowHeight = 600;
            //展开时查询产品型号，
            $scope.service.productmodelData = {};
            $scope.gridOptions.onRegisterApi = function (gridApi) {
                gridApi.expandable.on.rowExpandedStateChanged($scope, function (row) {
                    //row.isExpanded
                    if (!row.entity.hasOwnProperty('subGridOptions') || row.entity.subGridOptions.data == undefined) {
                        //产品型号列头
                        row.entity.subGridOptions = portColumns();
                        //查询产品型号
                        $scope.selectproductmodel(row.entity);
                        //row.entity.subGridOptions.data = $scope.service.dpuportlistArray;
                    }
                });
            };
            //表格列头
            $scope.gridOptions.columnDefs = columns($scope, uiGridConstants);
            //显示、隐藏检索方法
            $scope.toggleFiltering = function () {
                $scope.gridOptions.enableFiltering = !$scope.gridOptions.enableFiltering;
                $scope.gridApi.core.notifyDataChange(uiGridConstants.dataChange.COLUMN);
            };
            //获取产品与之相关联数据的数量      
            $scope.getTypeRefSouceLength = function (row, type) {
                var refCount = 0;
                if (type == 0) {
                    //产品型号
                    angular.forEach($scope.service.productmodelData, function (value, key) {
                        if (value.typeid == row.entity.idproducttype) {
                            refCount++;
                        }
                    });
                }
                return refCount;
            };
            //刷新按钮
            $scope.refresh = refresh;

            //添加按钮
            $scope.add = function () {
                $scope.service.title = '新建产品类型';
                $scope.modalHtml = __URL + 'Crmproduct/Producttype/openmodal';
                $scope.modalController = 'modelProducttypeController';
                $scope.service.selectItem = '';
                //给一个默认的颜色
                $scope.service.selectItem = { labelclass: "#5661c9" };
                publicControllerAdd($scope);
            }
            //修改按钮
            $scope.updateInfo = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = "修改产品类型";
                $scope.modalHtml = __URL + 'Crmproduct/Producttype/openmodal';
                $scope.modalController = 'modelProducttypeController';
                $scope.service.selectItem = row.entity;
                publicControllerUpdate($scope);
            }
            //删除按钮
            $scope.remove = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = '删除产品类型';
                $scope.modalHtml = __URL + 'Crmproduct/Producttype/openmodal';
                $scope.modalController = 'modelProducttypeController';
                $scope.service.selectItem = row.entity;
                publicControllerDel($scope);
            }
            //关联产品型号按钮
            $scope.refproductmodel = function (grid, row, col, rowRenderIndex, colRenderIndex) {
                $scope.service.title = '关联产品型号';
                $scope.modalHtml = __URL + 'Crmproduct/Producttype/openmodal';
                $scope.modalController = 'modelProducttypeController';
                $scope.service.selectItem = row.entity;
                $scope.service.Action = 3;
                publicControllerRef($scope);
            }
            /*
            查询产品型号数据
            */
            $scope.selectmodel = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmproduct/Productmodel/select_page_data', params).then(function (data) {
                    $scope.service.productmodelData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            //页面加载完成后，查询数据
            $scope.select();
        }]);
    </script>


</block>
<block name="pageContent">
    <!--页头-->
    <div class="page-header clearfix">
        <h1 class="col-xs-3 text-left">
            {$MenuName}
            <small>
                <i class="ace-icon fa fa-angle-double-right"></i>
                {$PageName}
            </small>
        </h1>
        <div class="col-xs-4 text-center">
            <page-btn></page-btn>
        </div>
    </div>
    <!--快速检索-->
    <div class="table-header clearfix">
        <div class="col-xs-6">{$MenuName}<small><i class="ace-icon fa fa-angle-double-right"></i>{$PageName}</small></div>
    </div>
    <div>
        <div ui-grid="gridOptions" ui-grid-expandable ui-grid-auto-resize ui-grid-resize-columns ui-grid-pagination ui-grid-empty-base-layer></div>
    </div>
</block>

<block name="scriptTemplate">

</block>

<block name="footjs">
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Product/Producttype/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Product/Productmodel/modal.js"></script>
    <script type="text/javascript" src="{$Think.const.JS_URL}directive.pagebtn.js"></script>
</block>
