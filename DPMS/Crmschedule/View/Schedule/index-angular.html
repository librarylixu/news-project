<extend name="angular-base.html" />
<block name="momentjs">
    <!--此处为moment js文件-->
    <script src="{$Think.const.BOOTSTRAP_URL}angular-datepicker/moment/moment.min.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-datepicker/moment/moment-timezone.js"></script>
</block>
<block name="headcss">
    <link href="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-calendar/0.30.0/css/angular-bootstrap-calendar.min.css" rel="stylesheet">
    <!--angular-datepicker-->
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angular-datepicker/angular-datepicker.css" />

    <!--自定义编辑页样式-->
    <link rel="stylesheet" href="{$Think.const.PAGE_URL}css/crmProject/my_widget.css" />
    <link rel="stylesheet" href="{$Think.const.PAGE_URL}css/crmProject/my-project-info.css" />
    <!-- tree -->
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angularTree/css/tree-control.css" />
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angularTree/css/tree-control-attribute.css" />
    <link rel="stylesheet" href="{$Think.const.CSS_URL}my-tree-style.css" />
    <!-- 选择颜色样式 -->
    <link rel="stylesheet" href="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-colorpicker/3.0.32/css/colorpicker.min.css">
    <style>
        .redcell {
            background-color: red;
        }
    </style>
</block>
<block name="headjs">
    <script src="{$Think.const.BOOTSTRAP_URL}angularTree/js/angular-tree-control.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-sanitize/{$Think.const.ANGULAR_VERSION}angular-sanitize.min.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}interact/1.3.1/interact.js"></script>
    <script type="text/javascript" src="{$Think.const.BOOTSTRAP_URL}angular/angular-locale_zh-cn.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-animate/{$Think.const.ANGULAR_VERSION}angular-animate.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}rrule/2.2.0/rrule.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-colorpicker/3.0.32/js/bootstrap-colorpicker-module.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-bootstrap-calendar/0.30.0/js/angular-bootstrap-calendar-tpls.js"></script>
    <script type="text/javascript" src="{$Think.const.BOOTSTRAP_URL}popups/0.0.2/angular-popups.js"></script>

    <script>
        appModuleInit(['mwl.calendar', 'ngAnimate', 'datePicker', 'ui.bootstrap', 'colorpicker.module', 'angular-popups', 'ngVerify', 'ngSanitize', 'treeControl']);
        appModule.controller('scheduleController', ['$scope', 'dataService', 'moment', 'alert', 'calendarConfig', '$uibModal',
        function ($scope, dataService, moment, alert, calendarConfig, $uibModal) {
            //给事件添加2个按钮
            var actions =
                [{
                    label: '<a href=""  class="blue"><i class="ace-icon fa fa-search bigger-125"></i></a>',
                    onClick: function (args) {
                        $scope.updateInfo(args.calendarEvent);
                    }
                }, {
                    label: '<a href="" class="red"><i class="ace-icon fa fa-times bigger-125"></i></a>',
                    onClick: function (args) {
                        $scope.remove(args.calendarEvent);
                    }
                }];
            //配置日历格子模板
            calendarConfig.templates.calendarMonthCell = __URL + 'Crmschedule/Schedule/calendarDay';
            $scope.calendarData = this;
            //指定日历表现方式为月
            $scope.calendarData.calendarView = 'month';
            //指定显示当前月的事件
            $scope.calendarData.viewDate = new Date();
            //全部的日程事件
            $scope.calendarData.events = [];
            //是否自动展开事件面板
            $scope.calendarData.cellIsOpen = true;
            $scope.service = dataService;
            $scope.allEvent = [];//全部的事件
            //查询全部事件
            $scope.select = function () {
                $scope.service.postData(__URL + 'Crmschedule/Schedule/select_page_data', {}).then(
                    function (data) {
                        $scope.service.allData = [];
                        angular.forEach(data, function (value, key) {
                            var _t = new Date().setTime(value.stime * 1000);
                            //固定写法，日程事件的开始时间
                            value.startsAt = _t;
                            _t = new Date().setTime(value.etime * 1000);
                            //固定写法，日程事件的结束时间
                            value.endsAt = _t;
                            //小圆圈的背景颜色
                            value.color = { primary: value.backgroundcolor, secondary: value.bordercolor };
                            //控制拖拽功能，true为可以拖拽，false为不准许
                            value.draggable = false;
                            //
                            value.resizable = false;
                            //属性名称
                            value.type = value.classname;
                            //把id给到events里。
                            value.calendarEventId = value.idschedule;
                            //固定写法，给事件添加2个按钮
                            value.actions = actions;

                            //value.recursOn: 'year';递归方式，每年/月/日 发生
                            $scope.service.allData.push(value);
                        });
                        $scope.allEvent = $scope.service.allData;
                        $scope.calendarData.events = $scope.allEvent;
                    }
                );
                //查询关联表的引用
                $scope.selectuser();
                $scope.selectusertype();
                $scope.selectusergroup();
                $scope.selectcustomer();
                $scope.selectcontact();
                $scope.selectworkorder();
                $scope.selectproject();
            }

            //初始化一个新的事件
            $scope.calendarData.newEvent = function () {
                return {
                    stime: ($scope.calendarData.selectDayItem.date._d.getTime() / 1000),//点击当前区块的时间
                    etime: ($scope.calendarData.selectDayItem.date._d.getTime() / 1000),//点击当前区块的时间
                    color: calendarConfig.colorTypes.important,
                    draggable: false,
                    resizable: false,
                    actions: actions,
                    type: 'info',
                    message: '',
                    url: null,
                };
            }
            //父子控制器通讯,提供给子控制器调用修改事件
            $scope.$on('eventClicked', function (event, data, status) {
                $scope.updateInfo(data, status);
            });
            //修改按钮
            $scope.updateInfo = function (row, status) {
                $scope.service.title = '详细信息';
                $scope.modalHtml = __URL + 'Crmschedule/Schedule/detail';
                $scope.modalController = 'modalController';
                $scope.service.modalPlacement = "right";
                $scope.service.modalSize = "md";
                row.stime = formatDate(row.stime, true);
                row.etime = formatDate(row.etime, true);
                $scope.service.selectItem = row;
                if (status == 1) {
                    publicControllerAdd($scope);
                } else {
                    publicControllerUpdate($scope);
                }
            }

            //事件删除事件
            $scope.remove = function (event) {
                $scope.service.title = '删除日程';
                $scope.service.selectItem = event;
                $scope.service.Action = 2;
                $scope.modalHtml = __URL + 'Crmschedule/Schedule/openmodal';
                $scope.modalController = 'modalController';
                publicControllerDel($scope);
            };
            //事件时间修改事件
            $scope.calendarData.eventTimesChanged = function (event) {
            };
            //时间拖拽事件
            $scope.calendarData.toggle = function ($event, field, event) {
                $event.preventDefault();
                $event.stopPropagation();
                event[field] = !event[field];
            };
            //加载时每个格子的渲染事件
            $scope.calendarData.modifyCell = function (date, cell) {
                //如果是月份的话
                if ($scope.calendarData.calendarView != 'month') {
                    return;
                }
                cell.cssClass = '';
                if (cell.isToday && $scope.calendarData.today == 0) {
                    cell.cssClass = 'redcell';  //**************** 计算今天的单元格并标记为红色
                    $scope.calendarData.selectDayItem = cell;
                    $scope.calendarData.today = cell;
                } else if (cell.date._d.getTime() == $scope.calendarData.selectDayItem.date._d.getTime()) {
                    cell.cssClass = 'redcell';
                    $scope.calendarData.selectDayItem = cell;
                }
            }
            //当前选中的时间块
            $scope.calendarData.selectDayItem = { cssClass: '', date: { _d: new Date() } };
            //今天
            $scope.calendarData.today = 0;
            //时间块点击事件
            $scope.calendarData.timespanClicked = function (date, cell) {
                if ($scope.calendarData.calendarView == 'day') {
                    //如果是日视图，点击的时候不做任何处理
                    return;
                }
                if ($scope.calendarData.selectDayItem.date._d.getTime() != cell.date._d.getTime()) {
                    $scope.calendarData.selectDayItem.cssClass = '';
                    cell.cssClass = 'redcell';
                    $scope.calendarData.selectDayItem = cell;
                }
                //这里处理一下，如果没有date那么就给其赋值
                if (date == 0) {
                    date = cell.date._d;
                }
                //当点击的是月视图时
                if ($scope.calendarData.calendarView === 'month') {
                    //判断当前点击的时间的时间黑条是否显示，cellIsOpen为false时，黑条显示，同时，判断当前点击的时间是否是
                    if (($scope.calendarData.cellIsOpen && moment(date).startOf('day').isSame(moment($scope.calendarData.viewDate).startOf('day'))) || cell.events.length < 1 || !cell.inMonth) {
                        //折叠
                        $scope.calendarData.cellIsOpen = false;
                        //说明此处不能折叠，这里判断了是否是本月的日期，如果不是，那么就不显示  ，这里标记一下，把时间定为到今天
                        if (cell.isToday) {
                            //导航到今天
                            $scope.calendarData.viewDate = cell.date._d;
                        }
                    } else {
                        //展开
                        $scope.calendarData.cellIsOpen = true;
                        //当前点击的时间赋给展开窗口中显示的时间
                        $scope.calendarData.viewDate = date;
                        //防止样式赋值失败
                        cell.cssClass = 'redcell';
                    }
                } else if ($scope.calendarData.calendarView === 'year') {
                    if (($scope.calendarData.cellIsOpen && moment(date).startOf('month').isSame(moment($scope.calendarData.viewDate).startOf('month'))) || cell.events.length === 0) {
                        $scope.calendarData.cellIsOpen = false;
                    } else {
                        $scope.calendarData.cellIsOpen = true;
                        $scope.calendarData.viewDate = date;
                    }
                }
            };
            //此处做关联表的查询操作
            /*
            查询用户数据
            */
            $scope.selectuser = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/Users/select_page_data', params).then(function (data) {
                    $scope.service.usersData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询用户角色数据
            */
            $scope.selectusertype = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/Usertype/select_page_data', params).then(function (data) {
                    $scope.service.usertypeData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询用户组数据
            */
            $scope.selectusergroup = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmuser/Usergroup/select_page_data', params).then(function (data) {
                    $scope.service.usergroupData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询客户数据
            */
            $scope.selectcustomer = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmcustomerinfo/Customerinfo/select_page_data', params).then(function (data) {
                    $scope.service.customerinfoData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询工单数据
            */
            $scope.selectworkorder = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmschedule/Workorder/select_page_data', params).then(function (data) {
                    $scope.service.workorderData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询联系人数据
            */
            $scope.selectcontact = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmcustomerinfo/Contact/select_page_data', params).then(function (data) {
                    $scope.service.contactData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            /*
            查询项目数据
            */
            $scope.selectproject = function () {
                var params = new URLSearchParams();
                params.append('$json', true);
                dataService.postData(__URL + 'Crmproject/Project/select_page_data', params).then(function (data) {
                    $scope.service.projectData = data;
                }, function (error) {
                    console.log(error);
                });
            }
            $scope.select();
            $scope.service.calendarData = $scope.calendarData;
        }
        ]);
    </script>
    <script>
        //日期块模板控制器
        appModule.controller('dayMonthController', ['$scope', 'dataService', 'alert', function ($scope, dataService, alert) {
            $scope.service = dataService;
            $scope.Source = angular.copy(dataService);
            //修改事件
            //设置关联、属性等
            $scope.onEventClick = function (data, status) {
                if (status == 1) {
                    $scope.save(0);
                    $scope.Source.selectItem.idschedule = $scope.service.selectItem.idschedule;
                }
                $scope.$emit('eventClicked', data, status);//调用父级的修改事件
            };
            $scope.changeStatus = function (row) {
                if (row == 0) {
                    $scope.Source.Action = 0;
                } else if (row == 1) {
                    $scope.Source.Action = 1;
                } else if (row == 3) {
                    $scope.Source.Action = 3;
                }
            }
            //项目提示框
            $scope.dynamicPopover = {
                title_name: $scope.service.calendarData.calendarTitle,
                templateUrl: __URL + 'Crmschedule/Schedule/openmodal',
            };
            //确认按钮
            $scope.save = function (status) {
                var params = new URLSearchParams();
                if ($scope.service.Action == 2) {
                    //delete
                    params.append('idschedule', $scope.service.selectItem.idschedule);
                    params.append('del', 1);
                    url = __URL + "Crmschedule/Schedule/update_page_data";
                } else {
                    //add
                    params.append('userid', 1);//这里的userid要放在tp控制器中，取session值
                    url = __URL + "Crmschedule/Schedule/add_page_data";
                    params.append('title', $scope.Source.selectItem.title);
                    //此处进行判断,是否修改了时间，如果没修改就不存数据库
                    //这里请注意，保存到数据库中是一个时间戳
                    if ($scope.service.Action == 1) {
                        params.append('stime', $scope.service.selectItem.startsAt / 1000);
                    } else if ($scope.service.Action == 0 && $scope.Source.selectItem.stime != undefined) {
                        params.append('stime', $scope.Source.selectItem.stime._i / 1000);
                    }
                    if ($scope.service.Action == 1) {
                        params.append('etime', $scope.service.selectItem.endsAt / 1000);
                    } else if ($scope.service.Action == 0 && $scope.Source.selectItem.etime != undefined) {
                        params.append('etime', $scope.Source.selectItem.etime._i / 1000);
                    }
                    if ($scope.Source.selectItem.message != undefined) {
                        params.append('message', $scope.Source.selectItem.message);
                    }
                    if ($scope.Source.selectItem.url != undefined) {
                        params.append('url', $scope.Source.selectItem.url);
                    }
                    if ($scope.Source.selectItem.type != undefined) {
                        params.append('classname', $scope.Source.selectItem.type);
                    }
                    if ($scope.Source.selectItem.color != undefined && $scope.Source.selectItem.color.primary != undefined) {
                        params.append('backgroundcolor', $scope.Source.selectItem.color.primary);
                    }
                    if ($scope.Source.selectItem.color != undefined && $scope.Source.selectItem.color.secondary != undefined) {
                        params.append('bordercolor', $scope.Source.selectItem.color.secondary);
                    }
                    if ($scope.service.Action == 1) {
                        //update
                        url = __URL + "Crmschedule/Schedule/update_page_data";
                        params.append('idschedule', $scope.Source.selectItem.idschedule);
                    }
                    //此处做额外判断,结束时间必须大于起始时间
                    if ($scope.service.Action == 0 && $scope.Source.selectItem.etime._i < $scope.Source.selectItem.stime._i) {
                        alert.show('结束时间错误,请重新填写', '日程管理');
                        return;
                    }
                }
                $scope.service.postData(url, params).then(
                      function (data) {
                          if (data < 1) {
                              alert.show('保存失败', '日程管理');
                          } else if ($scope.service.Action == 2) {
                              //delete
                              var i = dataService.allData.indexOf(dataService.selectItem);
                              if (i > -1) {
                                  dataService.allData.splice(i, 1);
                              }
                          } else {
                              //update add
                              $scope.service.selectItem.startsAt = new Date().setTime($scope.service.selectItem.stime * 1000);
                              $scope.service.selectItem.endsAt = new Date().setTime($scope.service.selectItem.etime * 1000);
                              if ($scope.service.Action == 0) {
                                  alert.show('添加成功', '添加日程');
                                  $scope.service.selectItem.idschedule = $scope.service.selectItem.calendarEventId = data;
                                  dataService.addData($scope.service.selectItem);
                              } else if ($scope.service.Action == 1) {
                                  alert.show('修改成功', '添加日程');
                                  dataService.updateData($scope.service.selectItem);
                              }
                          }

                      }, function () {
                          alert.show('失败了', '添加日程');
                      }
                 );
            };
        }]);
    </script>
</block>
<!--
    mwl-calendar  日程插件
    events 日程上的事件
    view 指定日历表现方式：年、月、日、周
    view-title 插件的标题  calendarData.calendarTitle 内置的属性,直接表明是哪年哪月哪周
    view-date  未知
    on-event-click 事件点击事件-也是小圆点点击事件
    on-event-times-changed 事件时间修改事件
    cell-is-open 是否自动展开事件面板
    cell-auto-open-disabled  默认打开今天的事件面板 true/false
    on-timespan-click  表格单元格的点击事件，格子点击事件
    day-view-split 未知（日视图单元格）
    cell-modifier  加载时每个格子的渲染事件
-->

<block name="pageContent">
    <div ng-app="appModule">
        <div class="container-fluid">
            <h2 class="text-center">{{ calendarData.calendarTitle }}</h2>
            <hr />
            <br />
            <ng-include src="'__APP__/Crmschedule/Schedule/calendarTop'"></ng-include>
            <br>
            <div class="row">
                <div class="col-xs-11 pull-right">
                    <mwl-calendar events="calendarData.events"
                                  view="calendarData.calendarView"
                                  view-title="calendarData.calendarTitle"
                                  view-date="calendarData.viewDate"
                                  on-event-click="calendarData.eventClicked(calendarEvent)"
                                  on-event-times-changed="calendarData.eventTimesChanged(calendarEvent); calendarEvent.startsAt = calendarNewEventStart; calendarEvent.endsAt = calendarNewEventEnd"
                                  cell-is-open="calendarData.cellIsOpen"
                                  cell-auto-open-disabled="false"
                                  day-view-split="10"
                                  cell-modifier="calendarData.modifyCell(calendarDate,calendarCell)"
                                  on-timespan-click="calendarData.timespanClicked(calendarDate, calendarCell)">
                    </mwl-calendar>
                </div>
            </div>
        </div>

    </div>
</block>


<block name="scriptTemplate">


</block>


<block name="footjs">
    <script src="{$Think.const.BOOTSTRAP_URL}angular-datepicker/tools/datePicker.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-datepicker/tools/datePickerUtils.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-datepicker/tools/dateRange.js"></script>
    <script src="{$Think.const.BOOTSTRAP_URL}angular-datepicker/tools/input.js"></script>
    <script type="text/javascript" src="{$Think.const.PAGE_URL}js/Crmschedule/Schedule/modal.js"></script>
</block>



