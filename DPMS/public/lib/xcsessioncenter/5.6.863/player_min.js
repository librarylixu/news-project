svGlobal.Player=function(l){function D(){d=m=h=0;q=b=null;n=!1;a.state=a.CLOSED;d=m=h=0;q=b=null;n=!1}function v(a,c){return(a[c]&255)<<24|(a[c+1]&255)<<16|(a[c+2]&255)<<8|a[c+3]&255}function G(){m+=w;a.onprogress(m,h)}function H(e,c){if(a.state!=a.PLAYING)d-=8;else{var f=e.target.result,k=function(){x&&(clearInterval(x),x=0);if(a.onprogress)a.onprogress(c,h);m=c;if(a.state==a.PLAYING){d+=f.byteLength;if(y)a.onmessage({data:f.slice(2)});else a.onmessage({data:f});r(8,z)}else d-=8};if(a.state==a.PLAYING){var g=
n?0:c-m;if(10>g||0==m)g=0;n&&0<p&&c>=p&&(b.getDesktop&&b.getDesktop().pause(!1),n=!1,p=0);0<g?q=setTimeout(k,g):k();g>3*w&&(x=setInterval(G,w))}}}function z(b){if(a.state==a.PLAYING){var c=new Int8Array(b.target.result);if(c&&8==c.length){b=v(c,0);var e=v(c,4);0>e&&(console.error("Duration:"+e),e=0);c=function(a){E=e;H(a,e)};a.state==a.PLAYING&&(d+=8,r(b,c))}else{if(a.onprogress)a.onprogress(h,h);a.close()}}}function F(e){var c=new Int8Array(e.target.result);t=String.fromCharCode(c[0],c[1],c[2],c[3]);
e=(c[4]&255)<<8|c[5]&255;var f=(c[6]&255)<<8|c[7]&255,k=(c[8]&255)<<8|c[9]&255,g=c[10]&255;m=0;h=v(c,19)<<32|v(c,23);console.log("total time:"+h+" type:"+t+" width:"+f+" height:"+k+" color:"+g);if(f&&k){w=h/100|0;if(b&&b.running())b.resetStatus&&b.resetStatus();else if("RDPV"==t)(c=svManager.getInstance())&&c.close(),b=new svGlobal.Rdp(a,f,k,g),b.displayMsg=!1,b.addSurface(l),b.run();else if("VNCV"==t)(c=svManager.getInstance())&&c.close(),b=new svGlobal.Vnc(a,f,k,g),b.displayMsg=!1,b.addSurface(l),
b.run();else if("SSHV"==t)y=!0,(c=svManager.getInstance())&&c.close(),b=new svGlobal.SSH(a,f,k,g),b.displayMsg=!1,b.addSurface(l),b.run();else if("TELV"==t)y=!0,(c=svManager.getInstance())&&c.close(),b=new svGlobal.TELNET(a,f,k,g),b.displayMsg=!1,b.addSurface(l),b.run();else{hi5.notifications.notify("Invalid format!");return}if(a.onopen)a.onopen();if(a.onopened)a.onopened({width:f,height:k,color:g,version:e,length:h,size:A.size});d=64;0<p&&b.getDesktop&&b.getDesktop().pause(!0);r(8,z)}else hi5.notifications.notify("Invalid resolution, width:"+
f+" height:"+k)}function r(b,c){if(a.state!=a.PLAYING){if(8==b)return;d-=8}if(B){var e=A.slice(d,d+b);u=new FileReader;u.onload=c;u.readAsArrayBuffer(e)}else d=0,B=!0,r(64,F)}var a=this,d=0,m=0,h=0,w=0,x=0,A=null,q=null,b=null,u=null,n=!1,C=!1,p=0,t="",y=!1;this.PLAYING=0;this.PAUSED=1;this.CLOSED=3;var E=0;this.state=this.CLOSED;var B=!0;l||(l=new svGlobal.LocalInterface);l.setReadOnly(!0);l.hideWhenClose=!1;this.getSurface=function(){return l};this.close=function(){console.log("Player closed");
try{if(a.onclose&&(a.onclose({code:0,reason:""}),a.onclose=null),b&&(b.close(),b=null),a.onend)a.onend()}finally{D()}};this.setSource=function(b){if(u){try{u.abort()}catch(c){}u=null}a.state==a.PLAYING?(a.state=a.CLOSED,C=!0,q&&(clearTimeout(q),q=null),a.close()):(D(),C=!1);if(b){if(!("slice"in b||(b.slice=b.webkitSlice||b.mozSlice,"slice"in b))){alert(__svi18n.file.slice);return}A=b}else alert(__svi18n.player.noinput)};this.send=function(){};this.play=function(){a.state=a.PLAYING;if(0==d){var b=
function(){d=0;r(64,F)};C?setTimeout(b,888):b()}else r(8,z)};this.scan=function(b){n=b};this.pause=function(){a.state=a.PAUSED};this.seek=function(a){b&&(n=!0,b.getDesktop&&b.getDesktop().pause(!0),p=parseInt(h*a/100),console.log("call for player"+a+"==="+p),p<E&&(B=!1))};this.setVolume=function(a){b&&b.setVolume&&b.setVolume(a)}};svGlobal.RdpPlayer=svGlobal.Player;
